# Конвертация Word → Markdown

Инструкция по конвертации Word-документов (.docx) в структурированные Markdown-файлы.

## Структура папки

```
sources/
├── word-files/                          ← сюда кладём .docx файлы
├── 1-1-self-development/               ← сконвертированный курс
├── 1-2-self-development-methods/       ← сконвертированный курс
├── 1-3-systems-thinking-introduction/  ← сконвертированный курс
├── format-guide.md                     ← правила форматирования (справочник)
└── README.md                           ← эта инструкция
```

Каждый сконвертированный курс хранится в отдельной папке внутри `sources/` с именем курса в kebab-case (например, `1-3-systems-thinking-introduction`).

## Предварительные условия

Конвертация выполняется **на локальном компьютере** через терминал (командную строку).

**Что нужно:**
- macOS или Linux
- Склонированный репозиторий `docs` (`git clone https://github.com/aisystant/docs.git`)
- Терминал (Terminal.app на macOS, или встроенный терминал в VS Code / Cursor)

**Кто запускает:** Любой участник команды, у которого есть клон репозитория и .docx файл курса.

## Пошаговая инструкция

### Шаг 1. Положить Word-файл

Скопируйте `.docx` файл в папку `sources/word-files/`:

```
sources/word-files/мой-курс.docx
```

Требования к файлу:
- Заголовки в Word оформлены стилями (Заголовок 1, Заголовок 2 и т.д.)
- Заголовок 1 = разделы курса (будут папками)
- Заголовок 2 = подразделы (будут отдельными .md файлами)
- Изображения вставлены в документ (будут извлечены автоматически)

### Шаг 2. Установить зависимости (только первый раз)

Откройте терминал и перейдите в папку репозитория:

```bash
cd ~/путь/к/docs
```

Установите зависимости:

```bash
# pandoc — конвертер документов
brew install pandoc

# Python-пакет для транслитерации
pip3 install -r scripts/convert_word/requirements.txt
```

### Шаг 3. Получить aisystant_code

Перед конвертацией **обязательно запросите код интеграции** у автора курса или администратора платформы Aisystant. Без этого кода скрипт не запустится.

### Шаг 4. Запустить конвертацию

В терминале, находясь в корне репозитория `docs/`:

```bash
./scripts/convert_word/run.sh "sources/word-files/мой-курс.docx" sources/имя-курса \
  --aisystant-code "КОД"
```

Где:
- `sources/имя-курса` — путь к папке, в которую будет записан результат конвертации. Вы сами выбираете имя этой папки. Имя должно быть в kebab-case (латиница, через дефисы, без пробелов). Например: `sources/1-3-systems-thinking-introduction`
- `КОД` — код интеграции с Aisystant (обязательный)

Можно указать название курса:

```bash
./scripts/convert_word/run.sh "sources/word-files/мой-курс.docx" sources/1-3-systems-thinking-introduction \
  --aisystant-code "SM2024-01" --course-title "Введение в системное мышление"
```

Скрипт автоматически:
1. Конвертирует .docx → Markdown через pandoc
2. Разобьёт на разделы и подразделы по заголовкам (H1 → папки, H2 → файлы)
3. Переведёт русские заголовки на английский (Google Translate) для имён папок и файлов
4. Извлечёт и переименует изображения (формат `fig-01`, `fig-02`...)
5. Распределит сноски — каждый файл получит только те определения `[^N]:`, на которые есть ссылки в его тексте
6. Уберёт Pandoc-артефакты (тире `---`/`--` → `—`, span-атрибуты `{.underline}`, двойные пробелы и т.д.)
7. Определит тип подраздела по заголовку (text, table, checklist, multiple_choice)
8. Сгенерирует YAML front matter для каждого файла
9. Запустит валидацию по правилам format-guide.md

### Шаг 5. Проверить результат

Результат конвертации появится в `sources/имя-курса/`:

```
sources/имя-курса/
├── index.md                              ← главная страница курса
├── 00-intro/
│   ├── index.md
│   ├── 01-about-the-guide.md             ← имена на английском (Google Translate)
│   └── 02-tasks-preparation-for-training.md
├── 01-physical-world-and-mental-space/   ← папки тоже на английском
│   ├── index.md
│   ├── 01-what-is-mental-space.md
│   ├── 02-theory-models-and-descriptions-of-reality.md
│   └── assets/
│       ├── fig-01.png
│       └── fig-02.png
└── ...
```

Что проверить:
- Откройте несколько .md файлов — текст, форматирование, заголовки
- Проверьте, что изображения на месте (папки `assets/`)
- Проверьте сноски — определения `[^N]:` должны быть в конце каждого файла, где есть ссылки `[^N]`
- Обратите внимание на предупреждения валидатора в консоли

Можно запустить валидацию отдельно:

```bash
python3 scripts/convert_word/validate.py sources/имя-курса/
```

### Шаг 6. Перенести в docs/ru/

После проверки переместите результат в нужную категорию:

```bash
# Для курсов категории "personal"
mv sources/имя-курса docs/ru/personal/имя-курса

# Для курсов категории "professional"
mv sources/имя-курса docs/ru/professional/имя-курса
```

## Повторная конвертация

Если нужно переконвертировать файл (например, обновлённая версия курса):

```bash
# Скрипт автоматически удалит старый результат и создаст заново
./scripts/convert_word/run.sh "sources/word-files/новая-версия.docx" sources/имя-курса \
  --aisystant-code "КОД"
```

## Как работает скрипт

Pipeline из 3 этапов:

1. **pandoc** — конвертирует .docx в один большой .md файл + извлекает все изображения
2. **Python (convert.py)** — разбивает по заголовкам, создаёт структуру папок, переводит имена на английский (Google Translate), распределяет сноски и изображения, убирает Pandoc-артефакты, определяет типы подразделов, генерирует front matter
3. **Python (validate.py)** — проверяет результат по правилам format-guide.md

### Очистка Pandoc-артефактов

При конвертации из Word pandoc оставляет артефакты, которые скрипт автоматически убирает:
- `[текст]{.underline}` → `**текст**`
- `[текст]{.mark}` → `текст`
- ` --- ` и ` -- ` → ` — ` (em-dash) — в заголовках и в тексте
- Двойные пробелы после номеров списков (`1.  текст` → `1. текст`)
- Атрибуты ширины изображений `{width=...}`

### Обработка сносок

Word-документы часто содержат сноски. Pandoc при конвертации собирает все определения сносок в конец файла. Скрипт:
- Извлекает все определения `[^N]: текст` до разбивки на секции
- При записи каждого .md файла находит ссылки `[^N]` в тексте
- Добавляет в конец файла только те определения, на которые есть ссылки
- Нумерация сносок сохраняется сквозная из исходного Word-документа

## Справочные файлы

- **format-guide.md** — все правила форматирования (заголовки, изображения, сноски, front matter, типы подразделов)
- **scripts/convert_word/convert.py** — скрипт конвертации
- **scripts/convert_word/validate.py** — валидатор
- **scripts/convert_word/requirements.txt** — Python-зависимости (transliterate, deep-translator)
