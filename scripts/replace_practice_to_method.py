#!/usr/bin/env python3
"""
Онтологически корректная замена «практика» → «метод» в руководстве
«Практики саморазвития» → «Методы саморазвития».

Правило: «практика» = способ действия / метод → заменяем.
НЕ заменяем: «на практике» (= в реальности), «практически», «практическое»,
«практиковать(ся)» (глагол), «требует практики» (= тренировки, когда рядом уже есть «метод»).
"""

import re
import os
import sys
from pathlib import Path

GUIDE_DIR = Path(__file__).parent.parent / "docs" / "ru" / "personal" / "1-2-self-development-methods"

# ──────────────────────────────────────────────────────────────
# REPLACEMENT RULES — ordered from most specific to most general
# Each rule: (pattern, replacement)
# ──────────────────────────────────────────────────────────────

# Phase 0: Deduplication — remove "практик*" where "метод*" already exists
# in the same phrase (prevents "метод (метод)" after replacement)
PHASE0_DEDUP = [
    # "метод(е/у/ам) (практик*)" → remove parenthetical synonym
    ('методе (практике)', 'методе'),
    ('методам (практикам)', 'методам'),
    ('метод (практику)', 'метод'),
    ('метода(практики)', 'метода'),
    ('методу (практике)', 'методу'),
    ('**методы** (практики)', '**методы**'),
    # "практике (методах)" → keep "методах" (full replacement)
    ('практике (методах)', 'методах'),
    # Comma-list dedup: "методов, практик, стратегий" → "методов, стратегий"
    ('методов, практик, стратегий', 'методов, стратегий'),
    # "стиль, практика, метод" → "стиль, метод"
    ('стиль, практика, метод', 'стиль, метод'),
    # "новой практики, метода" → "нового метода" (synonym list dedup)
    ('новой практики, метода', 'нового метода'),
]

# Phase 1: Remove parenthetical "(методы)" / "(методов)" since after replacement it's redundant
PHASE1_RULES = [
    ('Мои практики (методы)', 'Мои методы'),
    ('практики (методы, способы, стили обучения)', 'методы (способы, стили обучения)'),
    ('практики (методы)', 'методы'),
    ('практик (методов)', 'методов'),
    ('Практики (методы)', 'Методы'),
    ('Практика (метод)', 'Метод'),
    ('практика (метод)', 'метод'),
]

# Phase 2: Multi-word phrases with adjective/pronoun agreement (feminine → masculine)
# ORDER MATTERS: longer/more-specific patterns FIRST.
# Dative "по + adj + практике" patterns MUST precede generic "adj + практике" patterns.
PHASE2_RULES = [
    # ══════════════════════════════════════════════════════════
    # DATIVE: "по" + adj + "практике" → "по" + adj_masc_dat + "методу"
    # These MUST come BEFORE generic "adj + практике" → prepositional rules
    # ══════════════════════════════════════════════════════════
    ('по каждой отдельной практике', 'по каждому отдельному методу'),
    ('по данной практике', 'по данному методу'),
    ('по каждой практике', 'по каждому методу'),
    ('по конкретной практике', 'по конкретному методу'),
    ('по определенной практике', 'по определенному методу'),
    ('по определённой практике', 'по определённому методу'),
    ('по соответствующей практике', 'по соответствующему методу'),
    ('по изучаемой практике', 'по изучаемому методу'),
    ('по этой практике', 'по этому методу'),
    ('по одной практике', 'по одному методу'),
    ('по первой практике', 'по первому методу'),
    ('по второй практике', 'по второму методу'),
    # ══════════════════════════════════════════════════════════
    # Multi-adjective patterns (BEFORE single-adj patterns)
    # ══════════════════════════════════════════════════════════
    ('каждой отдельной практике', 'каждом отдельном методе'),
    ('каждую отдельную практику', 'каждый отдельный метод'),
    # ══════════════════════════════════════════════════════════
    # Singular NOMINATIVE: adj-ая + практика → adj-ой/ый + метод
    # ══════════════════════════════════════════════════════════
    ('Данная практика', 'Данный метод'),
    ('данная практика', 'данный метод'),
    ('Эта практика', 'Этот метод'),
    ('эта практика', 'этот метод'),
    ('Каждая практика', 'Каждый метод'),
    ('каждая практика', 'каждый метод'),
    ('конкретная практика', 'конкретный метод'),
    ('какая практика', 'какой метод'),
    ('сама практика', 'сам метод'),
    ('новая практика', 'новый метод'),
    ('своя практика', 'свой метод'),
    ('отдельная практика', 'отдельный метод'),
    ('которая практика', 'который метод'),
    ('одна практика', 'один метод'),
    ('такая практика', 'такой метод'),
    ('классическая практика', 'классический метод'),
    ('культурная практика', 'культурный метод'),
    # ── NEW nominative patterns ──
    ('основная практика', 'основной метод'),
    ('Основная практика', 'Основной метод'),
    ('важная практика', 'важный метод'),
    ('прикладная практика', 'прикладной метод'),
    ('Прикладная практика', 'Прикладной метод'),
    ('простая практика', 'простой метод'),
    ('правильная практика', 'правильный метод'),
    ('осознанная практика', 'осознанный метод'),
    ('любая практика', 'любой метод'),
    ('Любая практика', 'Любой метод'),
    ('поставленная практика', 'поставленный метод'),
    ('Поставленная практика', 'Поставленный метод'),
    ('соответствующая практика', 'соответствующий метод'),
    ('текущая практика', 'текущий метод'),
    ('сложная практика', 'сложный метод'),
    ('профессиональная практика', 'профессиональный метод'),
    ('необходимая практика', 'необходимый метод'),
    ('досуговая практика', 'досуговый метод'),
    ('главная практика', 'главный метод'),
    ('мощная практика', 'мощный метод'),
    ('эффективная практика', 'эффективный метод'),
    # ══════════════════════════════════════════════════════════
    # Singular GENITIVE: adj-ой/ей + практики → adj-ого/его + метода
    # ══════════════════════════════════════════════════════════
    ('данной практики', 'данного метода'),
    ('этой практики', 'этого метода'),
    ('каждой практики', 'каждого метода'),
    ('одной практики', 'одного метода'),
    ('конкретной практики', 'конкретного метода'),
    ('какой практики', 'какого метода'),
    ('самой практики', 'самого метода'),
    ('новой практики', 'нового метода'),
    ('отдельной практики', 'отдельного метода'),
    ('такой практики', 'такого метода'),
    ('соответствующей практики', 'соответствующего метода'),
    ('эффективной практики', 'эффективного метода'),
    ('ежедневной практики', 'ежедневного метода'),
    ('важной практики', 'важного метода'),
    ('прикладной практики', 'прикладного метода'),
    ('главной практики', 'главного метода'),
    ('поставленной практики', 'поставленного метода'),
    ('вашей практики', 'вашего метода'),
    ('второй практики', 'второго метода'),
    ('первой практики', 'первого метода'),
    ('определенной практики', 'определенного метода'),
    ('определённой практики', 'определённого метода'),
    ('изучаемой практики', 'изучаемого метода'),
    ('осваиваемой практики', 'осваиваемого метода'),
    ('основной практики', 'основного метода'),
    ('любой практики', 'любого метода'),
    ('классический вариант практики', 'классический вариант метода'),
    # ══════════════════════════════════════════════════════════
    # Singular DATIVE (standalone, without "по"):
    # adj-ой/ей + практике → adj-ому/ему + методу
    # NOTE: only for explicitly dative contexts (no preposition)
    # Generic "adj + практике" = prepositional → see below
    # ══════════════════════════════════════════════════════════
    # (most dative contexts have "по" prefix, handled above)

    # ══════════════════════════════════════════════════════════
    # Singular PREPOSITIONAL: adj-ой/ей + практике → adj-ом/ем + методе
    # ══════════════════════════════════════════════════════════
    ('данной практике', 'данном методе'),
    ('этой практике', 'этом методе'),
    ('каждой практике', 'каждом методе'),
    ('одной практике', 'одном методе'),
    ('конкретной практике', 'конкретном методе'),
    ('соответствующей практике', 'соответствующем методе'),
    ('эффективной практике', 'эффективном методе'),
    ('ежедневной практике', 'ежедневном методе'),
    ('важной практике', 'важном методе'),
    ('прикладной практике', 'прикладном методе'),
    ('главной практике', 'главном методе'),
    ('мощной практике', 'мощном методе'),
    ('поставленной практике', 'поставленном методе'),
    ('вашей практике', 'вашем методе'),
    ('второй практике', 'втором методе'),
    ('первой практике', 'первом методе'),
    ('определенной практике', 'определенном методе'),
    ('определённой практике', 'определённом методе'),
    ('отдельной практике', 'отдельном методе'),
    ('изучаемой практике', 'изучаемом методе'),
    ('предлагаемой практике', 'предлагаемом методе'),
    ('новой практике', 'новом методе'),
    ('какой практике', 'каком методе'),
    ('любой практике', 'любом методе'),
    ('основной практике', 'основном методе'),
    # ══════════════════════════════════════════════════════════
    # Singular ACCUSATIVE: adj-ую + практику → adj-ый/ой + метод
    # ══════════════════════════════════════════════════════════
    ('данную практику', 'данный метод'),
    ('эту практику', 'этот метод'),
    ('каждую практику', 'каждый метод'),
    ('одну практику', 'один метод'),
    ('конкретную практику', 'конкретный метод'),
    ('какую практику', 'какой метод'),
    ('саму практику', 'сам метод'),
    ('новую практику', 'новый метод'),
    ('свою практику', 'свой метод'),
    ('отдельную практику', 'отдельный метод'),
    ('определенную практику', 'определенный метод'),
    ('определённую практику', 'определённый метод'),
    ('предлагаемую практику', 'предлагаемый метод'),
    ('следующую практику', 'следующий метод'),
    # ── NEW accusative patterns ──
    ('соответствующую практику', 'соответствующий метод'),
    ('прикладную практику', 'прикладной метод'),
    ('текущую практику', 'текущий метод'),
    ('сложную практику', 'сложный метод'),
    ('профессиональную практику', 'профессиональный метод'),
    ('необходимую практику', 'необходимый метод'),
    ('досуговую практику', 'досуговый метод'),
    ('главную практику', 'главный метод'),
    ('основную практику', 'основной метод'),
    ('важную практику', 'важный метод'),
    ('любую практику', 'любой метод'),
    ('поставленную практику', 'поставленный метод'),
    # ══════════════════════════════════════════════════════════
    # Singular INSTRUMENTAL: adj-ой/ей + практикой → adj-ым/им + методом
    # ══════════════════════════════════════════════════════════
    ('данной практикой', 'данным методом'),
    ('этой практикой', 'этим методом'),
    ('каждой практикой', 'каждым методом'),
    ('одной практикой', 'одним методом'),
    ('конкретной практикой', 'конкретным методом'),
    ('соответствующей практикой', 'соответствующим методом'),
    ('ежедневной практикой', 'ежедневным методом'),
    ('важной практикой', 'важным методом'),
    ('прикладной практикой', 'прикладным методом'),
    ('главной практикой', 'главным методом'),
    ('мощной практикой', 'мощным методом'),
    ('поставленной практикой', 'поставленным методом'),
    ('вашей практикой', 'вашим методом'),
    ('обязательной практикой', 'обязательным методом'),
    ('культурной практикой', 'культурным методом'),
    ('классической практикой', 'классическим методом'),
    ('осваиваемой практикой', 'осваиваемым методом'),
    ('изучаемой практикой', 'изучаемым методом'),
    ('любой практикой', 'любым методом'),
    # ══════════════════════════════════════════════════════════
    # PLURAL (no gender change needed for plural adjectives)
    # ══════════════════════════════════════════════════════════
    ('эти практики', 'эти методы'),
    ('этих практик', 'этих методов'),
    ('этим практикам', 'этим методам'),
    ('этими практиками', 'этими методами'),
    ('этих практиках', 'этих методах'),
    ('все практики', 'все методы'),
    ('всех практик', 'всех методов'),
    ('всем практикам', 'всем методам'),
    ('всеми практиками', 'всеми методами'),
    ('всех практиках', 'всех методах'),
    ('данные практики', 'данные методы'),
    ('данных практик', 'данных методов'),
    ('данных практиках', 'данных методах'),
    ('данным практикам', 'данным методам'),
    ('данными практиками', 'данными методами'),
    ('другие практики', 'другие методы'),
    ('других практик', 'других методов'),
    ('другими практиками', 'другими методами'),
    ('других практиках', 'других методах'),
    ('другим практикам', 'другим методам'),
    ('следующих практик', 'следующих методов'),
    ('следующие практики', 'следующие методы'),
    ('некоторые практики', 'некоторые методы'),
    ('некоторых практик', 'некоторых методов'),
    ('изученные практики', 'изученные методы'),
    ('изученных практик', 'изученных методов'),
    ('изученными практиками', 'изученными методами'),
    ('изученных практиках', 'изученных методах'),
    ('изученным практикам', 'изученным методам'),
    ('такие практики', 'такие методы'),
    ('таких практик', 'таких методов'),
    ('прикладные практики', 'прикладные методы'),
    ('прикладных практик', 'прикладных методов'),
    ('двигательные практики', 'двигательные методы'),
    ('двигательных практик', 'двигательных методов'),
    ('лучшие практики', 'лучшие методы'),
    ('лучших практик', 'лучших методов'),
    ('рабочие практики', 'рабочие методы'),
    ('рабочих практик', 'рабочих методов'),
    ('соответствующие практики', 'соответствующие методы'),
    ('наши практики', 'наши методы'),
    ('наших практик', 'наших методов'),
    ('нашим практикам', 'нашим методам'),
    ('нашими практиками', 'нашими методами'),
    ('свои практики', 'свои методы'),
    ('своих практик', 'своих методов'),
    ('Мои практики', 'Мои методы'),
    ('мои практики', 'мои методы'),
    ('моих практик', 'моих методов'),
    ('новые практики', 'новые методы'),
    ('новых практик', 'новых методов'),
    ('инженерные практики', 'инженерные методы'),
    ('основные практики', 'основные методы'),
    ('основных практик', 'основных методов'),
    ('такое практики', 'такое методы'),  # "что такое практики"
    ('определить практики', 'определить методы'),
    ('осваивать практики', 'осваивать методы'),
    ('выберете практики', 'выберете методы'),
    ('Применять практики', 'Применять методы'),
    ('применять практики', 'применять методы'),
    ('ключевых практик', 'ключевых методов'),
    ('ключевые практики', 'ключевые методы'),
    ('собственные практики', 'собственные методы'),
    ('собственных практик', 'собственных методов'),
    ('профессиональные практики', 'профессиональные методы'),
    ('профессиональных практик', 'профессиональных методов'),
    ('подобные практики', 'подобные методы'),
    ('подобных практик', 'подобных методов'),
    ('журналистские практики', 'журналистские методы'),
    ('дополнительные практики', 'дополнительные методы'),
    ('осваиваемых практик', 'осваиваемых методов'),
    ('предложенных практик', 'предложенных методов'),
    ('предложенными практиками', 'предложенными методами'),
    ('пару практик', 'пару методов'),
    ('несколько практик', 'несколько методов'),
    ('количеству практик', 'количеству методов'),
    ('количество практик', 'количество методов'),
    ('мировых практик', 'мировых методов'),
    ('конкретных практик', 'конкретных методов'),
    ('тех практик', 'тех методов'),
    ('каких практик', 'каких методов'),
    ('определенных практик', 'определенных методов'),
    ('определённых практик', 'определённых методов'),
    ('разных практик', 'разных методов'),
    ('устаревшие практики', 'устаревшие методы'),
    ('цивилизационными практиками', 'цивилизационными методами'),
    ('цивилизационные практики', 'цивилизационные методы'),
    ('предлагаемыми практиками', 'предлагаемыми методами'),
    ('предлагаемые практики', 'предлагаемые методы'),
    ('изучаемые практики', 'изучаемые методы'),
    ('изучаемых практик', 'изучаемых методов'),
    # ══════════════════════════════════════════════════════════
    # Verb + noun (standalone, no adjective)
    # ══════════════════════════════════════════════════════════
    ('большинству практик', 'большинству методов'),
    ('каждую из практик', 'каждый из методов'),
    ('овладеете практикой', 'овладеете методом'),
    ('владеете практикой', 'владеете методом'),
    ('владение практикой', 'владение методом'),
    # ══════════════════════════════════════════════════════════
    # NUMERAL: "две практики" → "два метода"
    # ══════════════════════════════════════════════════════════
    ('две практики', 'два метода'),
    ('двух практик', 'двух методов'),
]

# Phase 3: Standalone case replacements (no adjective prefix)
# These use regex to match word boundaries
# Order: longer/more specific first
PHASE3_RULES = [
    # ── Title pattern: "Практики саморазвития" ──
    (r'«Практики саморазвития»', '«Методы саморазвития»'),
    (r'«Практик саморазвития»', '«Методов саморазвития»'),
    (r'"Практики саморазвития"', '"Методы саморазвития"'),

    # ── Genitive plural "практик" → "методов" ──
    # After prepositions/nouns that take genitive
    (r'\bпрактик саморазвития\b', 'методов саморазвития'),
    (r'\bпрактик досуга\b', 'методов досуга'),
    (r'\bпрактик оформления\b', 'методов оформления'),
    (r'\bпрактик обучения\b', 'методов обучения'),
    (r'\bпрактик продления\b', 'методов продления'),
    (r'\bСписок практик\b', 'Список методов'),
    (r'\bсписок практик\b', 'список методов'),

    # ── Nominative/Accusative plural "практики" → "методы" ──
    # When followed by genitive noun (= nominative plural)
    (r'\bПрактики саморазвития\b', 'Методы саморазвития'),
    (r'\bпрактики саморазвития\b', 'методы саморазвития'),
    (r'\bпрактики досуга\b', 'методы досуга'),
    (r'\bпрактики ученика\b', 'методы ученика'),
    (r'\bпрактики преподавания\b', 'методы преподавания'),
    (r'\bпрактики продвижения\b', 'методы продвижения'),
    (r'\bпрактики обучения\b', 'методы обучения'),
    (r'\bпрактики руководства\b', 'методы руководства'),
    (r'\bпрактики восстановления\b', 'методы восстановления'),

    # ── Dative plural "практикам" → "методам" ──
    (r'\bпрактикам саморазвития\b', 'методам саморазвития'),
    (r'\bпрактикам досуга\b', 'методам досуга'),

    # ── Instrumental plural "практиками" → "методами" ──
    (r'\bпрактиками саморазвития\b', 'методами саморазвития'),
    (r'\bпрактиками досуга\b', 'методами досуга'),
    (r'\bпрактиками руководства\b', 'методами руководства'),

    # ── Prepositional plural "практиках" → "методах" ──
    (r'\bпрактиках саморазвития\b', 'методах саморазвития'),
    (r'\bпрактиках досуга\b', 'методах досуга'),

    # ── Singular with specific method names ──
    # Nominative: "практика X" → "метод X"
    (r'\bПрактика инвестирования\b', 'Метод инвестирования'),
    (r'\bпрактика инвестирования\b', 'метод инвестирования'),
    (r'\bПрактика систематического\b', 'Метод систематического'),
    (r'\bпрактика систематического\b', 'метод систематического'),
    (r'\bПрактика мышления\b', 'Метод мышления'),
    (r'\bпрактика мышления\b', 'метод мышления'),
    (r'\bПрактика организации\b', 'Метод организации'),
    (r'\bпрактика организации\b', 'метод организации'),
    (r'\bПрактика формирования\b', 'Метод формирования'),
    (r'\bпрактика формирования\b', 'метод формирования'),
    (r'\bПрактика стратегирования\b', 'Метод стратегирования'),
    (r'\bпрактика стратегирования\b', 'метод стратегирования'),
    (r'\bПрактика планирования\b', 'Метод планирования'),
    (r'\bпрактика планирования\b', 'метод планирования'),
    (r'\bпрактика досуга\b', 'метод досуга'),
    (r'\bпрактика познания\b', 'метод познания'),

    # Nominative plural: "применяются практики X" → "применяются методы X"
    (r'\bприменяются практики мышления\b', 'применяются методы мышления'),
    (r'\bприменяются практики\b', 'применяются методы'),

    # Genitive singular: "практики X" → "метода X" (after gen-triggering context)
    (r'\bпрактики инвестирования\b', 'метода инвестирования'),
    (r'\bпрактики систематического\b', 'метода систематического'),
    (r'\bпрактики мышления\b', 'метода мышления'),
    (r'\bпрактики организации\b', 'метода организации'),
    (r'\bпрактики формирования\b', 'метода формирования'),
    (r'\bпрактики стратегирования\b', 'метода стратегирования'),
    (r'\bпрактики планирования\b', 'метода планирования'),
    (r'\bпрактики бизнес-моделирования\b', 'метода бизнес-моделирования'),

    # Dative singular: "практике X" → "методе X" (prepositional — "в практике X")
    (r'\bпрактике инвестирования\b', 'методе инвестирования'),
    (r'\bв практике инвестирование\b', 'в методе инвестирование'),
    (r'\bпрактике систематического\b', 'методе систематического'),
    (r'\bпрактике мышления\b', 'методе мышления'),
    (r'\bпрактике организации\b', 'методе организации'),
    (r'\bпрактике формирования\b', 'методе формирования'),
    (r'\bпрактике стратегирования\b', 'методе стратегирования'),
    (r'\bпрактике планирования\b', 'методе планирования'),

    # Accusative singular: "практику X" → "метод X"
    (r'\bпрактику инвестирования\b', 'метод инвестирования'),
    (r'\bпрактику систематического\b', 'метод систематического'),
    (r'\bпрактику мышления\b', 'метод мышления'),
    (r'\bпрактику организации\b', 'метод организации'),
    (r'\bпрактику формирования\b', 'метод формирования'),
    (r'\bпрактику стратегирования\b', 'метод стратегирования'),
    (r'\bпрактику планирования\b', 'метод планирования'),
    (r'\bпрактику досуга\b', 'метод досуга'),
    (r'\bпрактику вместе\b', 'метод вместе'),

    # Instrumental singular: "практикой X" → "методом X"
    (r'\bпрактикой систематического\b', 'методом систематического'),
    (r'\bпрактикой мышления\b', 'методом мышления'),
    (r'\bпрактикой инвестирования\b', 'методом инвестирования'),
    (r'\bпрактикой мозгового\b', 'методом мозгового'),
    (r'\bпрактикой бизнес-моделирования\b', 'методом бизнес-моделирования'),

    # ── Generic patterns (standalone, no specific method name) ──
    # "с практикой" → "с методом"
    (r'\bс практикой\b', 'с методом'),
    (r'\bв практике\b', 'в методе'),
    (r'\bпо практике\b', 'по методу'),
    (r'\bпо практикам\b', 'по методам'),
    (r'\bиз практики\b', 'из метода'),
    (r'\bдля практики\b', 'для метода'),
    (r'\bбез практики\b', 'без метода'),

    # "освоить практику" → "освоить метод"
    (r'\bосвоить практику\b', 'освоить метод'),
    (r'\bосвоил практику\b', 'освоил метод'),
    (r'\bосвоила практику\b', 'освоила метод'),
    (r'\bосвоения практики\b', 'освоения метода'),
    (r'\bосвоении практики\b', 'освоении метода'),
    (r'\bосвоению практики\b', 'освоению метода'),
    (r'\bосвоению практик\b', 'освоению методов'),

    # "реализации практики" → "реализации метода"
    (r'\bреализации практики\b', 'реализации метода'),
    (r'\bреализуете практику\b', 'реализуете метод'),

    # "применения практики" → "применения метода"
    (r'\bприменения практики\b', 'применения метода'),
    (r'\bиспользовать практику\b', 'использовать метод'),

    # "важность практики" → "важность метода"
    (r'\bважность практики\b', 'важность метода'),

    # "принципы/параметры практики" → "принципы/параметры метода"
    (r'\bпринципы практики\b', 'принципы метода'),
    (r'\bПринципы практики\b', 'Принципы метода'),
    (r'\bпринципов практики\b', 'принципов метода'),
    (r'\bпараметры практики\b', 'параметры метода'),

    # "продукты практики" → "продукты метода"
    (r'\bпродукты практики\b', 'продукты метода'),

    # "помощью практики" → "помощью метода"
    (r'\bпомощью практики\b', 'помощью метода'),

    # "в рамках практики" → "в рамках метода"
    (r'\bрамках практики\b', 'рамках метода'),

    # "счет практики" → "счет метода"
    (r'\bсчет практики\b', 'счет метода'),

    # "этапов/этап практики" → "этапов/этап метода"
    (r'\bэтапов практики\b', 'этапов метода'),
    (r'\bэтап практики\b', 'этап метода'),

    # "постановки практики" → "постановки метода"
    (r'\bпостановки практики\b', 'постановки метода'),

    # "помочь практика" → "помочь метод"
    (r'\bпомочь практика\b', 'помочь метод'),

    # "устранить практика" → "устранить метод"
    (r'\bустранить практика\b', 'устранить метод'),

    # ── Remaining singular cases ──
    (r'\bКак практика\b', 'Как метод'),
    (r'\bкак практика\b', 'как метод'),
    (r'\bчто практика\b', 'что метод'),

    # ── Catch-all for remaining "практик*" with specific right context ──
    (r'\bпрактики и\b', 'методы и'),
    (r'\bпрактики,\b', 'методы,'),
    (r'\bпрактики в\b', 'методы в'),
    (r'\bпрактики необходимо\b', 'методы необходимо'),
    (r'\bпрактики для\b', 'методы для'),
    (r'\bпрактики свое\b', 'методы свое'),
    (r'\bпрактики между\b', 'методы между'),
    (r'\bпрактики связаны\b', 'методы связаны'),

    # ── Additional specific patterns ──
    (r'\bПрактика Помодоро\b', 'Метод Помодоро'),
    (r'\bпрактика Помодоро\b', 'метод Помодоро'),
    (r'\bпрактики Помодоро\b', 'метода Помодоро'),
    (r'\bпрактику Помодоро\b', 'метод Помодоро'),
    (r'\bПрактика кроля\b', 'Метод кроля'),
    (r'\bпрактика кроля\b', 'метод кроля'),
    (r'\bпрактики кроля\b', 'метода кроля'),
    (r'\bпрактику кроля\b', 'метод кроля'),
    (r'\bпрактики технического\b', 'методы технического'),
    (r'\bпрактики романиста\b', 'методы романиста'),
    (r'\bпрактики гигиены\b', 'методы гигиены'),

    # "практика, которая" → "метод, который" (gender change!)
    (r'\bпрактика, которая\b', 'метод, который'),
    (r'\bпрактика, которую\b', 'метод, который'),
    (r'\bпрактика, которой\b', 'метод, которым'),
    (r'\bпрактика, целью\b', 'метод, целью'),

    # "Практика саморазвития" (singular) → "Метод саморазвития"
    (r'\bПрактика саморазвития\b', 'Метод саморазвития'),
    (r'\bпрактика саморазвития\b', 'метод саморазвития'),

    # Capital forms at start of sentences
    (r'\bПрактику инвестирования\b', 'Метод инвестирования'),
    (r'\bПрактики досуга\b', 'Методы досуга'),
    (r'\bПрактику досуга\b', 'Метод досуга'),
    (r'\bПрактике\b', 'Методе'),
    (r'\bПрактику\b', 'Метод'),
    (r'\bПрактики\b', 'Методы'),

    # "которые практики" → "которые методы" (if used as noun)
    (r'\bпрактики, которые\b', 'методы, которые'),

    # "мастер практики" → "мастер метода"
    (r'\bмастер практики\b', 'мастер метода'),

    # standalone "практик" (gen.pl.) at end of phrase
    (r'\bпрактик\[', 'методов['),  # before footnotes
    (r'\bпрактик,\b', 'методов,'),
    (r'\bпрактик\.\b', 'методов.'),

    # "название практики" → "название метода"
    (r'\bНазвание практики\b', 'Название метода'),
    (r'\bназвание практики\b', 'название метода'),

    # "показатели практики" → "показатели метода"
    (r'\bпоказатели практики\b', 'показатели метода'),

    # ── Dative verbs ──
    (r'\bучиться практике\b', 'учиться методу'),
    (r'\bуделяем практике\b', 'уделяем методу'),

    # ── Generic catch-alls ──
    (r'\bпрактикам\b', 'методам'),
    (r'\bпрактиками\b', 'методами'),
    (r'\bпрактиках\b', 'методах'),
    (r'\bпрактики\b(?=\s*[,;:\.\)\]])', 'методы'),
    (r'(?<=\d )\bпрактики\b', 'методы'),
    (r'(?<=две )\bпрактики\b', 'методы'),
    (r'(?<=три )\bпрактики\b', 'методы'),
    (r'(?<=четыре )\bпрактики\b', 'методы'),
    (r'(?<=восемь )\bпрактики\b', 'методы'),

    # ── Additional missed patterns ──
    (r'\bпрактик(?=[\s,\.\)\]\[:;])', 'методов'),
]

# Phase 4: Final catch-all (very broad — applied last)
# These handle remaining instances not caught by specific rules
PHASE4_RULES = [
    # "практику" → "метод" (acc.sg.)
    (r'\bпрактику\b', 'метод'),
    # "практикой" → "методом" (instr.sg.)
    (r'\bпрактикой\b', 'методом'),
    # "практике" (prep.sg.) — "на практике" already excluded
    (r'\bпрактике\b', 'методе'),
    # "практика" (nom.sg.) — the base form
    (r'\bпрактика\b', 'метод'),
    (r'\bПрактика\b', 'Метод'),
    # "практики" (nom.pl. or gen.sg.) — remaining cases
    (r'\bпрактики\b', 'методы'),
    # "практик" (gen.pl.) — remaining
    (r'\bпрактик\b', 'методов'),
]

# Phase 5: Post-replacement fixes
# Applied AFTER all phases to fix gender agreement, dative case, and pronouns
PHASE5_POSTFIX = [
    # ══════════════════════════════════════════════════════════
    # DATIVE FIX: "по X-ом/ем методе" → "по X-ому/ему методу"
    # After Phase 2+4, "практике" becomes "методе" (prepositional).
    # When preceded by "по", it should be dative "методу" instead.
    # The adjective ending -ом (prep.) must change to -ому (dat.)
    # ══════════════════════════════════════════════════════════
    # Two adjectives: "по Xом Yом методе" → "по Xому Yому методу"
    (r'\bпо (\w+)ом (\w+)ом методе\b', r'по \1ому \2ому методу'),
    (r'\bпо (\w+)ем (\w+)ом методе\b', r'по \1ему \2ому методу'),
    # Single adjective: "по Xом методе" → "по Xому методу"
    (r'\bпо (\w+)ом методе\b', r'по \1ому методу'),
    (r'\bпо (\w+)ем методе\b', r'по \1ему методу'),
    # With "-то" particle: "по какой-то методе" → "по какому-то методу"
    (r'\bпо какой-то методе\b', 'по какому-то методу'),
    # Bare: "по методе" → "по методу"
    (r'\bпо методе\b', 'по методу'),
    # ── "к" + dative (same pattern as "по") ──
    (r'\bк (\w+) (\w+)ом методе\b', r'к \1 \2ому методу'),
    (r'\bк (\w+) (\w+)ем методе\b', r'к \1 \2ему методу'),
    (r'\bк (\w+)ом методе\b', r'к \1ому методу'),
    (r'\bк (\w+)ем методе\b', r'к \1ему методу'),
    (r'\bк методе\b', 'к методу'),
    # Other dative triggers (verbs that take dative):
    (r'\bучиться методе\b', 'учиться методу'),
    (r'\bуделяем методе\b', 'уделяем методу'),
    # ══════════════════════════════════════════════════════════
    # GENDER FIX: "которая" → "который" (after masculine "метод")
    # ══════════════════════════════════════════════════════════
    (r'\bметод, которая\b', 'метод, который'),
    (r'\bметод которая\b', 'метод который'),
    (r'\bметода, которая\b', 'метода, который'),
    (r'\bметода которая\b', 'метода который'),
    (r'\bметоде, которая\b', 'методе, который'),
    (r'\bметоде которая\b', 'методе который'),
    (r'\bметодом, которая\b', 'методом, который'),
    (r'\bметоду, которая\b', 'методу, который'),
    (r'\bметод, которую\b', 'метод, который'),
    (r'\bметод, которой\b', 'метод, которого'),
    # With intervening word(s):
    (r'\b(метод[аеуом]?)\s+(\w+)\s+(\w+),\s+которая\b', r'\1 \2 \3, который'),
    (r'\b(метод[аеуом]?)\s+(\w+),\s+которая\b', r'\1 \2, который'),
    (r'\b(метод[аеуом]?)\s+(\w+)\s+которая\b', r'\1 \2 который'),
    # ══════════════════════════════════════════════════════════
    # PARTICIPLE FIX: "призвана" → "призван" (after masculine "метод")
    # ══════════════════════════════════════════════════════════
    (r'\bпризвана устранить метод\b', 'призван устранить метод'),
    (r'\bкоторая призвана\b', 'который призван'),
    # ══════════════════════════════════════════════════════════
    # PRONOUN FIX: feminine → masculine (safe contexts only)
    # ══════════════════════════════════════════════════════════
    (r'\bумеете ею\b', 'умеете им'),
    (r'\bв ее описании\b', 'в его описании'),
    # "выполнение её принципов" → "выполнение его принципов" (when about метод)
    (r'\bвыполнение её принципов\b', 'выполнение его принципов'),
]


def apply_rules(text: str, rules: list, is_regex: bool = True) -> tuple[str, int]:
    """Apply replacement rules to text. Returns (new_text, change_count).

    When is_regex=False, wraps literal patterns with \\b word boundaries
    to prevent substring matches (e.g. 'практик' inside 'практиках').
    Only adds \\b where the pattern starts/ends with a word character,
    because \\b requires a word/non-word boundary transition.
    """
    changes = 0
    for pattern, replacement in rules:
        if is_regex:
            regex = pattern
        else:
            escaped = re.escape(pattern)
            # Only add \b where the pattern starts/ends with a word character
            prefix = r'\b' if re.match(r'\w', pattern) else ''
            suffix = r'\b' if re.search(r'\w$', pattern) else ''
            regex = prefix + escaped + suffix
        new_text = re.sub(regex, replacement, text)
        if new_text != text:
            changes += len(re.findall(regex, text))
            text = new_text
    return text, changes


def protect_and_restore(line: str, phase_fn) -> tuple[str, int]:
    """Protect excluded phrases with placeholders, apply changes, then restore.

    Uses auto-numbered §§P{N}§§ placeholders for ALL protected phrases,
    handles multiple occurrences per pattern via while-loop.
    """
    PROTECT_PATTERNS = [
        r'активной практики',
        r'методов, практики, технологии',
        r'методов, практики,',
        r'на практике(?!\s+(?:инвестирования|мышления|систематического|планирования|стратегирования|организации|формирования|досуга|саморазвития))',
        r'будете практиковаться',
        r'практиковать\S*',
        r'практиковал\S*',
        r'практикуе\S*',
        r'практикую\b',
        r'практикуй\S*',
        r'практикуя\S*',
        r'практикующ\S*',
        r'попрактикуй\S*',
        r'практическ\S*',
    ]

    placeholders = {}
    protected = line
    counter = 0

    for pattern in PROTECT_PATTERNS:
        while True:
            m = re.search(pattern, protected, re.IGNORECASE)
            if not m:
                break
            key = f'§§P{counter}§§'
            placeholders[key] = m.group(0)
            protected = protected[:m.start()] + key + protected[m.end():]
            counter += 1

    result, changes = phase_fn(protected)

    for placeholder, original_text in placeholders.items():
        result = result.replace(placeholder, original_text)

    return result, changes


def process_line(line: str) -> tuple[str, int]:
    """Process a single line, applying all replacement phases."""
    original = line

    # Check if line has any "практик" or dedup targets at all (quick skip)
    lower = line.lower()
    if 'практик' not in lower and 'Практик' not in line:
        # Still check for Phase 5 post-fixes on already-processed content
        return line, 0

    def do_replacements(text):
        total = 0
        # Phase 0: Deduplication of existing "метод"+"практика" co-occurrences
        text, c0 = apply_rules(text, PHASE0_DEDUP, is_regex=False)
        total += c0
        # Phase 1: Remove redundant parenthetical "(методы)"
        text, c1 = apply_rules(text, PHASE1_RULES, is_regex=False)
        total += c1
        # Phase 2: Multi-word phrases with agreement changes
        text, c2 = apply_rules(text, PHASE2_RULES, is_regex=False)
        total += c2
        # Phase 3: Specific patterns with regex
        text, c3 = apply_rules(text, PHASE3_RULES, is_regex=True)
        total += c3
        # Phase 4: Catch-all
        remaining = re.findall(r'практик[а-яё]*\b', text.lower())
        noun_remaining = [r for r in remaining if not re.match(
            r'практиков(ать|ал|ала|ало|али|ан|ана|ано|аны|ания|аний)|практикуе|практикую|практикуй|практикуясь|практикуйте|практикуется|практикуют|практикуясь|практическ',
            r
        )]
        if noun_remaining:
            text, c4 = apply_rules(text, PHASE4_RULES, is_regex=True)
            total += c4
        # Phase 5: Post-replacement fixes (dative, gender, pronouns)
        text, c5 = apply_rules(text, PHASE5_POSTFIX, is_regex=True)
        total += c5
        return text, total

    line, changes = protect_and_restore(original, do_replacements)

    if line != original:
        return line, changes
    return line, 0


def process_file(filepath: Path, dry_run: bool = False) -> dict:
    """Process a single file. Returns stats dict."""
    with open(filepath, 'r', encoding='utf-8') as f:
        lines = f.readlines()

    new_lines = []
    total_changes = 0
    line_changes = []

    for i, line in enumerate(lines, 1):
        new_line, changes = process_line(line)
        new_lines.append(new_line)
        if changes > 0:
            total_changes += changes
            line_changes.append({
                'line': i,
                'original': line.rstrip(),
                'replaced': new_line.rstrip(),
                'count': changes,
            })

    if not dry_run and total_changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.writelines(new_lines)

    return {
        'file': str(filepath),
        'changes': total_changes,
        'details': line_changes,
    }


def main():
    dry_run = '--dry-run' in sys.argv
    verbose = '--verbose' in sys.argv or '-v' in sys.argv

    if not GUIDE_DIR.exists():
        print(f"ERROR: Guide directory not found: {GUIDE_DIR}")
        sys.exit(1)

    md_files = sorted(GUIDE_DIR.rglob('*.md'))
    print(f"Found {len(md_files)} markdown files in {GUIDE_DIR}")
    if dry_run:
        print("=== DRY RUN (no files modified) ===\n")

    total_files_changed = 0
    total_replacements = 0
    all_results = []

    for filepath in md_files:
        result = process_file(filepath, dry_run=dry_run)
        all_results.append(result)
        if result['changes'] > 0:
            total_files_changed += 1
            total_replacements += result['changes']
            rel = filepath.relative_to(GUIDE_DIR)
            print(f"  [{result['changes']:3d}] {rel}")
            if verbose:
                for d in result['details']:
                    print(f"        L{d['line']}: {d['original'][:100]}")
                    print(f"            → {d['replaced'][:100]}")

    print(f"\n{'='*60}")
    print(f"Total files changed: {total_files_changed} / {len(md_files)}")
    print(f"Total replacements:  {total_replacements}")
    if dry_run:
        print("(DRY RUN — no files were modified)")

    # Report remaining "практик" occurrences (potential misses)
    if not dry_run:
        print(f"\n{'='*60}")
        print("Checking for remaining 'практик' occurrences...")
        remaining = 0
        for filepath in md_files:
            with open(filepath, 'r', encoding='utf-8') as f:
                for i, line in enumerate(f, 1):
                    if re.search(r'практик', line, re.IGNORECASE):
                        # Check if it's an acceptable remaining form
                        lower = line.lower()
                        is_ok = bool(re.search(
                            r'практическ|практиковать|практиковал|практикуе|практикую|практикуй|практикуя|практикующ|практиковаться|попрактикуй|на практике(?!\s+(?:инвестирования|мышления|систематического))|активной практики|методов, практики',
                            lower
                        ))
                        if not is_ok:
                            remaining += 1
                            rel = filepath.relative_to(GUIDE_DIR)
                            if verbose:
                                print(f"  REMAINING: {rel}:{i}: {line.rstrip()[:120]}")
        print(f"Remaining 'практик' occurrences (potential misses): {remaining}")

        # Report gender agreement issues
        print(f"\n{'='*60}")
        print("Checking for gender agreement issues...")
        gender_issues = 0
        for filepath in md_files:
            with open(filepath, 'r', encoding='utf-8') as f:
                for i, line in enumerate(f, 1):
                    # Feminine adj + masculine "метод"
                    if re.search(r'\b\w+ая метод\b', line) or \
                       re.search(r'\b\w+ую метод\b', line) or \
                       re.search(r'призвана устранить метод', line) or \
                       re.search(r'которая призвана', line):
                        gender_issues += 1
                        rel = filepath.relative_to(GUIDE_DIR)
                        if verbose:
                            print(f"  GENDER: {rel}:{i}: {line.rstrip()[:120]}")
        print(f"Gender agreement issues: {gender_issues}")

        # Report dative issues
        print(f"\n{'='*60}")
        print("Checking for dative issues ('по ... методе')...")
        dative_issues = 0
        for filepath in md_files:
            with open(filepath, 'r', encoding='utf-8') as f:
                for i, line in enumerate(f, 1):
                    if re.search(r'\bпо \w+ методе\b', line) or \
                       re.search(r'\bпо методе\b', line):
                        dative_issues += 1
                        rel = filepath.relative_to(GUIDE_DIR)
                        if verbose:
                            print(f"  DATIVE: {rel}:{i}: {line.rstrip()[:120]}")
        print(f"Dative issues ('по ... методе'): {dative_issues}")

        # Report redundant "(метод)" parentheticals
        print(f"\n{'='*60}")
        print("Checking for redundant '(метод)' parentheticals...")
        dedup_issues = 0
        for filepath in md_files:
            with open(filepath, 'r', encoding='utf-8') as f:
                for i, line in enumerate(f, 1):
                    if re.search(r'метод\w*\s*\(метод', line, re.IGNORECASE):
                        dedup_issues += 1
                        rel = filepath.relative_to(GUIDE_DIR)
                        if verbose:
                            print(f"  DEDUP: {rel}:{i}: {line.rstrip()[:120]}")
        print(f"Redundant parentheticals: {dedup_issues}")


if __name__ == '__main__':
    main()
