#!/usr/bin/env python3
"""
Онтологически корректная замена «практика» → «метод» в руководстве
«Практики саморазвития» → «Методы саморазвития».

Правило: «практика» = способ действия / метод → заменяем.
НЕ заменяем: «на практике» (= в реальности), «практически», «практическое»,
«практиковать(ся)» (глагол), «требует практики» (= тренировки, когда рядом уже есть «метод»).
"""

import re
import os
import sys
from pathlib import Path

GUIDE_DIR = Path(__file__).parent.parent / "docs" / "ru" / "personal" / "1-2-self-development-methods"

# ──────────────────────────────────────────────────────────────
# REPLACEMENT RULES — ordered from most specific to most general
# Each rule: (pattern, replacement)
# ──────────────────────────────────────────────────────────────

# Phase 1: Remove parenthetical "(методы)" / "(методов)" since after replacement it's redundant
PHASE1_RULES = [
    ('Мои практики (методы)', 'Мои методы'),
    ('практики (методы, способы, стили обучения)', 'методы (способы, стили обучения)'),
    ('практики (методы)', 'методы'),
    ('практик (методов)', 'методов'),
    ('Практики (методы)', 'Методы'),
]

# Phase 2: Multi-word phrases with adjective/pronoun agreement (feminine → masculine)
PHASE2_RULES = [
    # ── Singular: данная ──
    ('Данная практика', 'Данный метод'),
    ('данная практика', 'данный метод'),
    ('данной практики', 'данного метода'),
    ('данной практике', 'данном методе'),
    ('данную практику', 'данный метод'),
    ('данной практикой', 'данным методом'),
    # ── Singular: эта ──
    ('Эта практика', 'Этот метод'),
    ('эта практика', 'этот метод'),
    ('этой практики', 'этого метода'),
    ('этой практике', 'этом методе'),
    ('эту практику', 'этот метод'),
    ('этой практикой', 'этим методом'),
    # ── Singular: каждая ──
    ('Каждая практика', 'Каждый метод'),
    ('каждая практика', 'каждый метод'),
    ('каждой практики', 'каждого метода'),
    ('каждой практике', 'каждом методе'),
    ('каждую практику', 'каждый метод'),
    ('каждой практикой', 'каждым методом'),
    # ── Singular: одна ──
    ('одна практика', 'один метод'),
    ('одной практики', 'одного метода'),
    ('одной практике', 'одном методе'),
    ('одну практику', 'один метод'),
    ('одной практикой', 'одним методом'),
    # ── Singular: конкретная ──
    ('конкретная практика', 'конкретный метод'),
    ('конкретной практики', 'конкретного метода'),
    ('конкретной практике', 'конкретном методе'),
    ('конкретную практику', 'конкретный метод'),
    ('конкретной практикой', 'конкретным методом'),
    # ── Singular: какая ──
    ('какая практика', 'какой метод'),
    ('какой практики', 'какого метода'),
    ('какую практику', 'какой метод'),
    ('какой практике', 'каком методе'),
    # ── Singular: сама ──
    ('сама практика', 'сам метод'),
    ('самой практики', 'самого метода'),
    ('саму практику', 'сам метод'),
    # ── Singular: новая/своя/отдельная ──
    ('новая практика', 'новый метод'),
    ('новой практики', 'нового метода'),
    ('новой практике', 'новом методе'),
    ('новую практику', 'новый метод'),
    ('своя практика', 'свой метод'),
    ('свою практику', 'свой метод'),
    ('отдельная практика', 'отдельный метод'),
    ('отдельной практики', 'отдельного метода'),
    ('отдельную практику', 'отдельный метод'),
    # ── Singular: которая ──
    ('которая практика', 'который метод'),

    # ── Plural (no gender change needed for plural adjectives) ──
    ('эти практики', 'эти методы'),
    ('этих практик', 'этих методов'),
    ('этим практикам', 'этим методам'),
    ('этими практиками', 'этими методами'),
    ('этих практиках', 'этих методах'),
    ('все практики', 'все методы'),
    ('всех практик', 'всех методов'),
    ('всем практикам', 'всем методам'),
    ('всеми практиками', 'всеми методами'),
    ('всех практиках', 'всех методах'),
    ('данные практики', 'данные методы'),
    ('данных практик', 'данных методов'),
    ('данных практиках', 'данных методах'),
    ('данным практикам', 'данным методам'),
    ('данными практиками', 'данными методами'),
    ('другие практики', 'другие методы'),
    ('других практик', 'других методов'),
    ('другими практиками', 'другими методами'),
    ('других практиках', 'других методах'),
    ('другим практикам', 'другим методам'),
    ('следующих практик', 'следующих методов'),
    ('следующие практики', 'следующие методы'),
    ('некоторые практики', 'некоторые методы'),
    ('некоторых практик', 'некоторых методов'),
    ('изученные практики', 'изученные методы'),
    ('изученных практик', 'изученных методов'),
    ('изученными практиками', 'изученными методами'),
    ('изученных практиках', 'изученных методах'),
    ('изученным практикам', 'изученным методам'),
    ('такие практики', 'такие методы'),
    ('таких практик', 'таких методов'),
    ('прикладные практики', 'прикладные методы'),
    ('прикладных практик', 'прикладных методов'),
    ('двигательные практики', 'двигательные методы'),
    ('двигательных практик', 'двигательных методов'),
    ('лучшие практики', 'лучшие методы'),
    ('лучших практик', 'лучших методов'),
    ('рабочие практики', 'рабочие методы'),
    ('рабочих практик', 'рабочих методов'),
    ('соответствующие практики', 'соответствующие методы'),
    ('наши практики', 'наши методы'),
    ('наших практик', 'наших методов'),
    ('нашим практикам', 'нашим методам'),
    ('нашими практиками', 'нашими методами'),
    ('свои практики', 'свои методы'),
    ('своих практик', 'своих методов'),
    ('Мои практики', 'Мои методы'),
    ('мои практики', 'мои методы'),
    ('моих практик', 'моих методов'),
    ('новые практики', 'новые методы'),
    ('новых практик', 'новых методов'),
    ('инженерные практики', 'инженерные методы'),
    ('основные практики', 'основные методы'),
    ('основных практик', 'основных методов'),
    ('такое практики', 'такое методы'),  # "что такое практики"
    ('определить практики', 'определить методы'),
    ('осваивать практики', 'осваивать методы'),
    ('выберете практики', 'выберете методы'),
    ('Применять практики', 'Применять методы'),
    ('применять практики', 'применять методы'),
    # ── Additional adjective patterns (missed in first pass) ──
    ('ключевых практик', 'ключевых методов'),
    ('ключевые практики', 'ключевые методы'),
    ('собственные практики', 'собственные методы'),
    ('собственных практик', 'собственных методов'),
    ('профессиональные практики', 'профессиональные методы'),
    ('профессиональных практик', 'профессиональных методов'),
    ('подобные практики', 'подобные методы'),
    ('подобных практик', 'подобных методов'),
    ('культурной практикой', 'культурным методом'),
    ('журналистские практики', 'журналистские методы'),
    ('дополнительные практики', 'дополнительные методы'),
    ('осваиваемых практик', 'осваиваемых методов'),
    ('осваиваемой практикой', 'осваиваемым методом'),
    ('осваиваемой практики', 'осваиваемого метода'),
    ('изучаемой практикой', 'изучаемым методом'),
    ('предлагаемой практике', 'предлагаемом методе'),
    ('предлагаемую практику', 'предлагаемый метод'),
    ('предложенных практик', 'предложенных методов'),
    ('пару практик', 'пару методов'),
    ('несколько практик', 'несколько методов'),
    ('количеству практик', 'количеству методов'),
    ('количество практик', 'количество методов'),
    ('обязательной практикой', 'обязательным методом'),
    ('такая практика', 'такой метод'),
    ('такой практики', 'такого метода'),
    ('определенной практики', 'определенного метода'),
    ('определенную практику', 'определенный метод'),
    ('классический вариант практики', 'классический вариант метода'),
    ('классическая практика', 'классический метод'),
    ('следующую практику', 'следующий метод'),
    # ── Additional adjective+noun patterns for gender agreement ──
    # Genitive singular (adj-ой/ей + практики → adj-ого/его + метода)
    ('соответствующей практики', 'соответствующего метода'),
    ('соответствующей практике', 'соответствующем методе'),
    ('соответствующей практикой', 'соответствующим методом'),
    ('эффективной практики', 'эффективного метода'),
    ('эффективной практике', 'эффективном методе'),
    ('ежедневной практики', 'ежедневного метода'),
    ('ежедневной практикой', 'ежедневным методом'),
    ('важной практики', 'важного метода'),
    ('важной практикой', 'важным методом'),
    ('прикладной практики', 'прикладного метода'),
    ('прикладной практике', 'прикладном методе'),
    ('прикладной практикой', 'прикладным методом'),
    ('главной практики', 'главного метода'),
    ('главной практике', 'главном методе'),
    ('главной практикой', 'главным методом'),
    ('мощной практике', 'мощном методе'),
    ('мощной практикой', 'мощным методом'),
    ('поставленной практики', 'поставленного метода'),
    ('поставленной практике', 'поставленном методе'),
    ('вашей практики', 'вашего метода'),
    ('вашей практике', 'вашем методе'),
    ('вашей практикой', 'вашим методом'),
    ('второй практике', 'втором методе'),
    ('второй практики', 'второго метода'),
    ('первой практике', 'первом методе'),
    ('первой практики', 'первого метода'),
    # Prepositional: adj-ой/ей + практике → adj-ом/ем + методе
    ('определенной практике', 'определенном методе'),
    ('определённой практике', 'определённом методе'),
    ('определенной практики', 'определенного метода'),
    ('определённой практики', 'определённого метода'),
    ('отдельной практике', 'отдельном методе'),
    ('отдельной практики', 'отдельного метода'),
    ('изучаемой практике', 'изучаемом методе'),
    ('изучаемой практики', 'изучаемого метода'),
    # "какой практике" / "какой Методе" (interrogative)
    ('какой практике', 'каком методе'),
    ('какой Практике', 'каком Методе'),
    # "основной практики" gen.sg.
    ('основной практики', 'основного метода'),
    ('основной практике', 'основном методе'),
    # любой
    ('любой практике', 'любом методе'),
    ('любой практики', 'любого метода'),
]

# Phase 3: Standalone case replacements (no adjective prefix)
# These use regex to match word boundaries
# Order: longer/more specific first
PHASE3_RULES = [
    # ── Title pattern: "Практики саморазвития" ──
    (r'«Практики саморазвития»', '«Методы саморазвития»'),
    (r'«Практик саморазвития»', '«Методов саморазвития»'),
    (r'"Практики саморазвития"', '"Методы саморазвития"'),

    # ── Genitive plural "практик" → "методов" ──
    # After prepositions/nouns that take genitive
    (r'\bпрактик саморазвития\b', 'методов саморазвития'),
    (r'\bпрактик досуга\b', 'методов досуга'),
    (r'\bпрактик оформления\b', 'методов оформления'),
    (r'\bпрактик обучения\b', 'методов обучения'),
    (r'\bпрактик продления\b', 'методов продления'),
    (r'\bСписок практик\b', 'Список методов'),
    (r'\bсписок практик\b', 'список методов'),

    # ── Nominative/Accusative plural "практики" → "методы" ──
    # When followed by genitive noun (= nominative plural)
    (r'\bПрактики саморазвития\b', 'Методы саморазвития'),
    (r'\bпрактики саморазвития\b', 'методы саморазвития'),
    (r'\bпрактики досуга\b', 'методы досуга'),
    (r'\bпрактики ученика\b', 'методы ученика'),
    (r'\bпрактики преподавания\b', 'методы преподавания'),
    (r'\bпрактики продвижения\b', 'методы продвижения'),
    (r'\bпрактики обучения\b', 'методы обучения'),
    (r'\bпрактики руководства\b', 'методы руководства'),

    # ── Dative plural "практикам" → "методам" ──
    (r'\bпрактикам саморазвития\b', 'методам саморазвития'),
    (r'\bпрактикам досуга\b', 'методам досуга'),

    # ── Instrumental plural "практиками" → "методами" ──
    (r'\bпрактиками саморазвития\b', 'методами саморазвития'),
    (r'\bпрактиками досуга\b', 'методами досуга'),
    (r'\bпрактиками руководства\b', 'методами руководства'),

    # ── Prepositional plural "практиках" → "методах" ──
    (r'\bпрактиках саморазвития\b', 'методах саморазвития'),
    (r'\bпрактиках досуга\b', 'методах досуга'),

    # ── Singular with specific method names ──
    # Nominative: "практика X" → "метод X"
    (r'\bПрактика инвестирования\b', 'Метод инвестирования'),
    (r'\bпрактика инвестирования\b', 'метод инвестирования'),
    (r'\bПрактика систематического\b', 'Метод систематического'),
    (r'\bпрактика систематического\b', 'метод систематического'),
    (r'\bПрактика мышления\b', 'Метод мышления'),
    (r'\bпрактика мышления\b', 'метод мышления'),
    (r'\bПрактика организации\b', 'Метод организации'),
    (r'\bпрактика организации\b', 'метод организации'),
    (r'\bПрактика формирования\b', 'Метод формирования'),
    (r'\bпрактика формирования\b', 'метод формирования'),
    (r'\bПрактика стратегирования\b', 'Метод стратегирования'),
    (r'\bпрактика стратегирования\b', 'метод стратегирования'),
    (r'\bПрактика планирования\b', 'Метод планирования'),
    (r'\bпрактика планирования\b', 'метод планирования'),
    (r'\bпрактика досуга\b', 'метод досуга'),

    # Genitive singular: "практики X" → "метода X" (after gen-triggering context)
    (r'\bпрактики инвестирования\b', 'метода инвестирования'),
    (r'\bпрактики систематического\b', 'метода систематического'),
    (r'\bпрактики мышления\b', 'метода мышления'),
    (r'\bпрактики организации\b', 'метода организации'),
    (r'\bпрактики формирования\b', 'метода формирования'),
    (r'\bпрактики стратегирования\b', 'метода стратегирования'),
    (r'\bпрактики планирования\b', 'метода планирования'),

    # Dative singular: "практике X" → "методе X"
    (r'\bпрактике инвестирования\b', 'методе инвестирования'),
    (r'\bв практике инвестирование\b', 'в методе инвестирование'),
    (r'\bпрактике систематического\b', 'методе систематического'),
    (r'\bпрактике мышления\b', 'методе мышления'),
    (r'\bпрактике организации\b', 'методе организации'),
    (r'\bпрактике формирования\b', 'методе формирования'),
    (r'\bпрактике стратегирования\b', 'методе стратегирования'),
    (r'\bпрактике планирования\b', 'методе планирования'),

    # Accusative singular: "практику X" → "метод X"
    (r'\bпрактику инвестирования\b', 'метод инвестирования'),
    (r'\bпрактику систематического\b', 'метод систематического'),
    (r'\bпрактику мышления\b', 'метод мышления'),
    (r'\bпрактику организации\b', 'метод организации'),
    (r'\bпрактику формирования\b', 'метод формирования'),
    (r'\bпрактику стратегирования\b', 'метод стратегирования'),
    (r'\bпрактику планирования\b', 'метод планирования'),
    (r'\bпрактику досуга\b', 'метод досуга'),
    (r'\bпрактику вместе\b', 'метод вместе'),

    # Instrumental singular: "практикой X" → "методом X"
    (r'\bпрактикой систематического\b', 'методом систематического'),
    (r'\bпрактикой мышления\b', 'методом мышления'),
    (r'\bпрактикой инвестирования\b', 'методом инвестирования'),

    # ── Generic patterns (standalone, no specific method name) ──
    # "с практикой" → "с методом"
    (r'\bс практикой\b', 'с методом'),
    (r'\bв практике\b', 'в методе'),
    (r'\bпо практике\b', 'по методу'),
    (r'\bпо практикам\b', 'по методам'),
    (r'\bиз практики\b', 'из метода'),
    (r'\bдля практики\b', 'для метода'),
    (r'\bбез практики\b', 'без метода'),

    # "освоить практику" → "освоить метод"
    (r'\bосвоить практику\b', 'освоить метод'),
    (r'\bосвоил практику\b', 'освоил метод'),
    (r'\bосвоила практику\b', 'освоила метод'),
    (r'\bосвоения практики\b', 'освоения метода'),
    (r'\bосвоении практики\b', 'освоении метода'),
    (r'\bосвоению практики\b', 'освоению метода'),

    # "реализации практики" → "реализации метода"
    (r'\bреализации практики\b', 'реализации метода'),
    (r'\bреализуете практику\b', 'реализуете метод'),

    # "применения практики" → "применения метода"
    (r'\bприменения практики\b', 'применения метода'),
    (r'\bиспользовать практику\b', 'использовать метод'),

    # "важность практики" → "важность метода"
    (r'\bважность практики\b', 'важность метода'),

    # "принципы/принципов/параметры практики" → "принципы/принципов/параметры метода"
    (r'\bпринципы практики\b', 'принципы метода'),
    (r'\bПринципы практики\b', 'Принципы метода'),
    (r'\bпринципов практики\b', 'принципов метода'),
    (r'\bпараметры практики\b', 'параметры метода'),

    # "продукты практики" → "продукты метода"
    (r'\bпродукты практики\b', 'продукты метода'),

    # "помощью практики" → "помощью метода"
    (r'\bпомощью практики\b', 'помощью метода'),

    # "в рамках практики" → "в рамках метода"
    (r'\bрамках практики\b', 'рамках метода'),

    # "счет практики" → "счет метода"
    (r'\bсчет практики\b', 'счет метода'),

    # "этапов/этап практики" → "этапов/этап метода"
    (r'\bэтапов практики\b', 'этапов метода'),
    (r'\bэтап практики\b', 'этап метода'),

    # "постановки практики" → "постановки метода"
    (r'\bпостановки практики\b', 'постановки метода'),

    # "помочь практика" → "помочь метод"
    (r'\bпомочь практика\b', 'помочь метод'),

    # "устранить практика" → "устранить метод"
    (r'\bустранить практика\b', 'устранить метод'),

    # ── Remaining singular cases ──
    # "Как практика" → "Как метод"
    (r'\bКак практика\b', 'Как метод'),
    (r'\bкак практика\b', 'как метод'),

    # "что практика" → "что метод"
    (r'\bчто практика\b', 'что метод'),

    # ── Catch-all for remaining "практик*" with specific right context ──
    # "практики и " (nom.pl. in enumeration) → "методы и"
    (r'\bпрактики и\b', 'методы и'),
    (r'\bпрактики,\b', 'методы,'),
    (r'\bпрактики в\b', 'методы в'),  # nom.pl. "практики в каждой группе"
    (r'\bпрактики необходимо\b', 'методы необходимо'),
    (r'\bпрактики для\b', 'методы для'),
    (r'\bпрактики свое\b', 'методы свое'),
    (r'\bпрактики между\b', 'методы между'),
    (r'\bпрактики связаны\b', 'методы связаны'),

    # ── Additional specific patterns ──
    (r'\bПрактика Помодоро\b', 'Метод Помодоро'),
    (r'\bпрактика Помодоро\b', 'метод Помодоро'),
    (r'\bпрактики Помодоро\b', 'метода Помодоро'),
    (r'\bпрактику Помодоро\b', 'метод Помодоро'),
    (r'\bПрактика кроля\b', 'Метод кроля'),
    (r'\bпрактика кроля\b', 'метод кроля'),
    (r'\bпрактики кроля\b', 'метода кроля'),
    (r'\bпрактику кроля\b', 'метод кроля'),
    (r'\bпрактики технического\b', 'методы технического'),
    (r'\bпрактики романиста\b', 'методы романиста'),
    (r'\bпрактики гигиены\b', 'методы гигиены'),

    # "практика, которая" → "метод, который" (gender change!)
    (r'\bпрактика, которая\b', 'метод, который'),
    (r'\bпрактика, которую\b', 'метод, который'),
    (r'\bпрактика, которой\b', 'метод, которым'),

    # "практика, целью" → "метод, целью"
    (r'\bпрактика, целью\b', 'метод, целью'),

    # "Практика саморазвития" (singular) → "Метод саморазвития"
    (r'\bПрактика саморазвития\b', 'Метод саморазвития'),
    (r'\bпрактика саморазвития\b', 'метод саморазвития'),

    # Capital forms at start of sentences
    (r'\bПрактику инвестирования\b', 'Метод инвестирования'),
    (r'\bПрактики досуга\b', 'Методы досуга'),
    (r'\bПрактику досуга\b', 'Метод досуга'),
    (r'\bПрактике\b', 'Методе'),
    (r'\bПрактику\b', 'Метод'),
    (r'\bПрактики\b', 'Методы'),

    # "которые практики" → "которые методы" (if used as noun)
    (r'\bпрактики, которые\b', 'методы, которые'),

    # "мастер практики" → "мастер метода"
    (r'\bмастер практики\b', 'мастер метода'),

    # standalone "практик" (gen.pl.) at end of phrase
    (r'\bпрактик\[', 'методов['),  # before footnotes
    (r'\bпрактик,\b', 'методов,'),
    (r'\bпрактик\.\b', 'методов.'),

    # "название практики" → "название метода"
    (r'\bНазвание практики\b', 'Название метода'),
    (r'\bназвание практики\b', 'название метода'),

    # "показатели практики" → "показатели метода"
    (r'\bпоказатели практики\b', 'показатели метода'),

    # ── Generic catch-alls ──
    # "практикам " → "методам "
    (r'\bпрактикам\b', 'методам'),
    # "практиками " → "методами "
    (r'\bпрактиками\b', 'методами'),
    # "практиках " → "методах "
    (r'\bпрактиках\b', 'методах'),
    # "практики" followed by punctuation (likely nom.pl.)
    (r'\bпрактики\b(?=\s*[,;:\.\)\]])', 'методы'),
    # "практики" preceded by number or quantifier
    (r'(?<=\d )\bпрактики\b', 'методы'),
    (r'(?<=две )\bпрактики\b', 'методы'),
    (r'(?<=три )\bпрактики\b', 'методы'),
    (r'(?<=четыре )\bпрактики\b', 'методы'),
    (r'(?<=восемь )\bпрактики\b', 'методы'),  # Should not exist, but safety

    # ── Additional missed patterns (from second pass analysis) ──
    ('мировых практик', 'мировых методов'),
    ('любой практикой', 'любым методом'),
    ('любой практики', 'любого метода'),
    ('конкретных практик', 'конкретных методов'),
    ('тех практик', 'тех методов'),
    ('каких практик', 'каких методов'),
    ('классической практикой', 'классическим методом'),
    ('поставленной практикой', 'поставленным методом'),
    ('определенных практик', 'определенных методов'),
    ('определённых практик', 'определённых методов'),
    ('разных практик', 'разных методов'),
    ('большинству практик', 'большинству методов'),
    ('каждую из практик', 'каждый из методов'),
    ('овладеете практикой', 'овладеете методом'),
    ('владеете практикой', 'владеете методом'),
    ('владение практикой', 'владение методом'),

    # standalone "практик" (gen.pl.) — this is after all specific patterns
    (r'\bпрактик(?=[\s,\.\)\]\[:;])', 'методов'),
]

# Phase 4: Final catch-all (very broad — applied last)
# These handle remaining instances not caught by specific rules
PHASE4_RULES = [
    # "практику" → "метод" (acc.sg.)
    (r'\bпрактику\b', 'метод'),
    # "практикой" → "методом" (instr.sg.)
    (r'\bпрактикой\b', 'методом'),
    # "практике" (prep.sg.) — "на практике" already excluded
    (r'\bпрактике\b', 'методе'),
    # "практика" (nom.sg.) — the base form
    (r'\bпрактика\b', 'метод'),
    (r'\bПрактика\b', 'Метод'),
    # "практики" (nom.pl. or gen.sg.) — remaining cases
    (r'\bпрактики\b', 'методы'),
    # "практик" (gen.pl.) — remaining
    (r'\bпрактик\b', 'методов'),
]

# Phase 5: Post-replacement gender agreement fixes
# Applied AFTER all phases to fix relative pronouns and any remaining adjective issues
PHASE5_POSTFIX = [
    # "метод, которая" → "метод, который" (all forms)
    (r'\bметод, которая\b', 'метод, который'),
    (r'\bметод которая\b', 'метод который'),
    (r'\bметода, которая\b', 'метода, который'),
    (r'\bметода которая\b', 'метода который'),
    (r'\bметоде, которая\b', 'методе, который'),
    (r'\bметоде которая\b', 'методе который'),
    (r'\bметодом, которая\b', 'методом, который'),
    (r'\bметоду, которая\b', 'методу, который'),
    (r'\bметоды, которая\b', 'метода, который'),  # also fix "методы" → "метода" (was gen.sg.)
    (r'\bметод, которую\b', 'метод, который'),
    (r'\bметод, которой\b', 'метод, которого'),
    # With intervening word(s) (e.g. "метода планирования, которая")
    # NB: excludes "методик*" which is already feminine
    (r'\b(метод[аеуом]?)\s+(\w+)\s+(\w+),\s+которая\b', r'\1 \2 \3, который'),
    (r'\b(метод[аеуом]?)\s+(\w+),\s+которая\b', r'\1 \2, который'),
    (r'\b(метод[аеуом]?)\s+(\w+)\s+которая\b', r'\1 \2 который'),
]


def apply_rules(text: str, rules: list, is_regex: bool = True) -> tuple[str, int]:
    """Apply replacement rules to text. Returns (new_text, change_count)."""
    changes = 0
    for pattern, replacement in rules:
        if is_regex:
            new_text = re.sub(pattern, replacement, text)
        else:
            new_text = text.replace(pattern, replacement)
        if new_text != text:
            if is_regex:
                changes += len(re.findall(pattern, text))
            else:
                changes += text.count(pattern)
            text = new_text
    return text, changes


def protect_and_restore(line: str, phase_fn) -> tuple[str, int]:
    """Protect excluded phrases with placeholders, apply changes, then restore.

    Uses auto-numbered §§P{N}§§ placeholders for ALL protected phrases,
    handles multiple occurrences per pattern via while-loop.
    """
    PROTECT_PATTERNS = [
        r'активной практики',
        r'методов, практики, технологии',
        r'методов, практики,',
        r'на практике(?!\s+(?:инвестирования|мышления|систематического|планирования|стратегирования|организации|формирования|досуга|саморазвития))',
        r'будете практиковаться',
        r'практиковать\S*',
        r'практиковал\S*',
        r'практикуе\S*',
        r'практикую\b',
        r'практикуй\S*',
        r'практикуя\S*',
        r'практикующ\S*',
        r'попрактикуй\S*',
        r'практическ\S*',
    ]

    placeholders = {}
    protected = line
    counter = 0

    for pattern in PROTECT_PATTERNS:
        while True:
            m = re.search(pattern, protected, re.IGNORECASE)
            if not m:
                break
            key = f'§§P{counter}§§'
            placeholders[key] = m.group(0)
            protected = protected[:m.start()] + key + protected[m.end():]
            counter += 1

    result, changes = phase_fn(protected)

    for placeholder, original_text in placeholders.items():
        result = result.replace(placeholder, original_text)

    return result, changes


def process_line(line: str) -> tuple[str, int]:
    """Process a single line, applying all replacement phases."""
    original = line

    # Check if line has any "практик" at all (quick skip)
    if 'практик' not in line.lower() and 'Практик' not in line:
        return line, 0

    def do_replacements(text):
        total = 0
        # Phase 1: Remove redundant parenthetical "(методы)"
        text, c1 = apply_rules(text, PHASE1_RULES, is_regex=False)
        total += c1
        # Phase 2: Multi-word phrases with agreement changes
        text, c2 = apply_rules(text, PHASE2_RULES, is_regex=False)
        total += c2
        # Phase 3: Specific patterns with regex
        text, c3 = apply_rules(text, PHASE3_RULES, is_regex=True)
        total += c3
        # Phase 4: Catch-all
        remaining = re.findall(r'практик[а-яё]*\b', text.lower())
        noun_remaining = [r for r in remaining if not re.match(
            r'практиков(ать|ал|ала|ало|али|ан|ана|ано|аны|ания|аний)|практикуе|практикую|практикуй|практикуясь|практикуйте|практикуется|практикуют|практикуясь|практическ',
            r
        )]
        if noun_remaining:
            text, c4 = apply_rules(text, PHASE4_RULES, is_regex=True)
            total += c4
        # Phase 5: Post-replacement gender agreement fixes
        text, c5 = apply_rules(text, PHASE5_POSTFIX, is_regex=True)
        total += c5
        return text, total

    line, changes = protect_and_restore(original, do_replacements)

    if line != original:
        return line, changes
    return line, 0


def process_file(filepath: Path, dry_run: bool = False) -> dict:
    """Process a single file. Returns stats dict."""
    with open(filepath, 'r', encoding='utf-8') as f:
        lines = f.readlines()

    new_lines = []
    total_changes = 0
    line_changes = []

    for i, line in enumerate(lines, 1):
        new_line, changes = process_line(line)
        new_lines.append(new_line)
        if changes > 0:
            total_changes += changes
            line_changes.append({
                'line': i,
                'original': line.rstrip(),
                'replaced': new_line.rstrip(),
                'count': changes,
            })

    if not dry_run and total_changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.writelines(new_lines)

    return {
        'file': str(filepath),
        'changes': total_changes,
        'details': line_changes,
    }


def main():
    dry_run = '--dry-run' in sys.argv
    verbose = '--verbose' in sys.argv or '-v' in sys.argv

    if not GUIDE_DIR.exists():
        print(f"ERROR: Guide directory not found: {GUIDE_DIR}")
        sys.exit(1)

    md_files = sorted(GUIDE_DIR.rglob('*.md'))
    print(f"Found {len(md_files)} markdown files in {GUIDE_DIR}")
    if dry_run:
        print("=== DRY RUN (no files modified) ===\n")

    total_files_changed = 0
    total_replacements = 0
    all_results = []

    for filepath in md_files:
        result = process_file(filepath, dry_run=dry_run)
        all_results.append(result)
        if result['changes'] > 0:
            total_files_changed += 1
            total_replacements += result['changes']
            rel = filepath.relative_to(GUIDE_DIR)
            print(f"  [{result['changes']:3d}] {rel}")
            if verbose:
                for d in result['details']:
                    print(f"        L{d['line']}: {d['original'][:100]}")
                    print(f"            → {d['replaced'][:100]}")

    print(f"\n{'='*60}")
    print(f"Total files changed: {total_files_changed} / {len(md_files)}")
    print(f"Total replacements:  {total_replacements}")
    if dry_run:
        print("(DRY RUN — no files were modified)")

    # Report remaining "практик" occurrences (potential misses)
    if not dry_run:
        print(f"\n{'='*60}")
        print("Checking for remaining 'практик' occurrences...")
        remaining = 0
        for filepath in md_files:
            with open(filepath, 'r', encoding='utf-8') as f:
                for i, line in enumerate(f, 1):
                    if re.search(r'практик', line, re.IGNORECASE):
                        # Check if it's an acceptable remaining form
                        lower = line.lower()
                        is_ok = bool(re.search(
                            r'практическ|практиковать|практиковал|практикуе|практикую|практикуй|практикуя|практикующ|практиковаться|попрактикуй|на практике(?!\s+(?:инвестирования|мышления|систематического))|активной практики|методов, практики',
                            lower
                        ))
                        if not is_ok:
                            remaining += 1
                            rel = filepath.relative_to(GUIDE_DIR)
                            if verbose:
                                print(f"  REMAINING: {rel}:{i}: {line.rstrip()[:120]}")
        print(f"Remaining 'практик' occurrences (potential misses): {remaining}")


if __name__ == '__main__':
    main()
